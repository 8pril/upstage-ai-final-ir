# upstage-ai-final-ir
Scientific Knowledge Question Answering | 과학 지식 질의 응답 RAG 시스템 구축

# 1. 대회 소개

## 1.1. 개요

LLM의 등장 이후 여러 산업 분야에서 지식을 다루는 업무들이 점점 고도화되고 있다. 정보를 찾기 위해 검색엔진 입력창에 키워드를 입력하고 검색하기를 반복하는 번거로운 과정을 반복할 필요 없이 이제 LLM한테 물어보면 질문의 의도까지 파악해서 필요한 내용만 잘 정리해서 알려준다.

그렇지만 LLM이 가진 근본적인 한계도 있다. 먼저, 정보라는 것은 의미나 가치가 시간에 따라 계속 변하기 때문에 모델이 이를 실시간으로 학습하기 힘들고 이 때문에 처럼 knowledge cutoff 가 자연스럽게 발생한다.

![image](https://aistages-api-public-prod.s3.amazonaws.com/app/Files/5e0853d5-8b59-4e48-a190-d27d60c99b1d.png)

그리고 LLM이 알려주는 지식이 항상 사실에 기반한 것이 아닌 경우가 종종 있다. 특히 특정 도메인이나 문제 영역은 매우 심각한 거짓 정보들을 생성해 내곤 한다. 

아래 예시에서 추천하는 맛집들은 모두 실재하지 않는 장소들이다.

![image](https://aistages-api-public-prod.s3.amazonaws.com/app/Files/9222ef2b-431d-44b7-985b-d6f28c7d87ee.png)

이러한 환각 현상은 메타인지를 학습하지 않은 LLM의 근본적인 한계라 볼 수 있다.  

이러한 문제를 극복하기 위해서는 RAG(Retrieval Augmented Generation) 기술이 필수이다. RAG는 질문에 적합한 레퍼런스 추출을 위해 검색엔진을 활용하고 답변 생성을 위해 LLM(Large Language Model)을 활용합니다. 이때 LLM은 사실에 기반한 지식 정보를 토대로 질문에 답을 하고 출처 정보도 같이 줄 수 있기 때문에 사용자는 더 안심하고 정보를 소비할 수 있게 된다.

![image](https://aistages-api-public-prod.s3.amazonaws.com/app/Files/097e532d-9301-4705-8df6-d958465a0e59.png)

이번 대회에서는 과학 상식을 질문하는 시나리오 하에 과학 상식 문서 4200여개를 미리 검색엔진에 색인해 둔다. 

대화 메시지 또는 질문이 들어오면 과학 상식에 대한 질문 의도인지 그렇지 않은 지 판단 후에 과학 상식 질문이라면 검색엔진으로부터 적합한 문서들을 추출하고 이를 기반으로 답변을 생성한다. 

만일 과학 상식 이외의 질문이라면 검색엔진을 활용할 필요 없이 적절한 답을 바로 생성한다.

## 1.2. 평가 지표

사용자가 입력한 질문에 대해서 답변을 얼마나 잘 생성했는지 정량화하는 작업은 매우 고난도의 작업이다. 대회에서는 자동화된 평가 방법을 적용해야 하기 때문에 RAG에 대한 end-to-end 평가 대신 적합한 레퍼런스를 얼마나 잘 추출했는지에 대한 평가만 진행한다.

이번 평가에서는 MAP(Mean Average Precision)라는 metric을 사용한다. MAP는 질의 N개에 대한 Average Precision의 평균 값을 구하고, Average Precision은 Precision-recall curve에서 아래쪽 면적을 의미한다.

계산 과정은 도식화하면 아래 그림과 같다.

![image](https://aistages-api-public-prod.s3.amazonaws.com/app/Files/84516087-bf8a-4ef0-ad49-a3e26ada48a7.png)

그런데 이번 대회에서는 MAP를 약간 변형하여 RAG 평가에 적합하도록 살짝 수정한 형태의 로직을 사용한다.

대화 메시지가 과학 상식에 대한 질문일 수도 있고 아닐수도 있기 때문에 과학 상식 질문이 아닌 경우는 문서를 추출할 필요가 없다. 그래서 검색이 필요없는 ground truth 항목에 대해서는 검색 결과가 없는 경우를 1점으로 주고 그렇지 않는 경우는 0점으로 계산하게 로직(아래 코드의 else 부분)을 추가했다

```python
def calc_map(gt, pred):
    sum_average_precision = 0
    for j in pred:
        if gt[j["eval_id"]]:
            hit_count = 0
            sum_precision = 0
            for i,docid in enumerate(j["topk"][:3]):
                if docid in gt[j["eval_id"]]:
                    hit_count += 1
                    sum_precision += hit_count/(i+1)
            average_precision = sum_precision / hit_count if hit_count > 0 else 0
        else:
            average_precision = 0 if j["topk"] else 1
        sum_average_precision += average_precision
    return sum_average_precision/len(pred)

```

## 1.3. 데이터 설명

- eval.jsonl
    - 총 220개 메시지
    - msg는 LLM이 받는 입력 포맷으로 구성
    - 검색 엔진 성능뿐만 아니라 LLM을 활용한 질의 의도 분석 및 standalone query 추출 성능도 평가해야 하기 때문에 20개의 멀티턴 대화 및 20개의 일반 대화를 포함
        - 멀티턴 대화
            
            ```json
            {"eval_id": 243, "msg": [
            	{"role": "user", "content": "사람이나 물체가 지구 위에서 땅속으로 꺼지거나 바깥으로 튕겨나가지 않고 가만히 서 있을 수 있잖아?"}, 
            	{"role": "assistant", "content": "네 맞습니다."}, 
            	{"role": "user", "content": "그 이유를 힘의 원리로 설명해줘."}]
            }
            ```
            
        - 과학 상식을 묻는 질문이 아니라 일반적인 대화 메시지
            
            ```json
            {"eval_id": 32, "msg": [{"role": "user", "content": "오늘 너무 즐거웠다!"}]}
            ```
            
- documents.jsonl
    - 과학 지식 정보를 담고 있는 순수 색인 대상 문서 4200여개
        - 'src': 출처, 'content': 실제 RAG에서 레퍼런스로 참고할 지식 정보
        
        ```json
        {"docid": "42508ee0-c543-4338-878e-d98c6babee66", "src": "ko_mmlu__nutrition__test", "content": "건강한 사람이 에너지 균형을 평형 상태로 유지하는 것은 중요합니다. 에너지 균형은 에너지 섭취와 에너지 소비의 수학적 동등성을 의미합니다. 일반적으로 건강한 사람은 1-2주의 기간 동안 에너지 균형을 달성합니다. 이 기간 동안에는 올바른 식단과 적절한 운동을 통해 에너지 섭취와 에너지 소비를 조절해야 합니다. 식단은 영양가 있는 식품을 포함하고, 적절한 칼로리를 섭취해야 합니다. 또한, 운동은 에너지 소비를 촉진시키고 근육을 강화시킵니다. 이렇게 에너지 균형을 유지하면 건강을 유지하고 비만이나 영양 실조와 같은 문제를 예방할 수 있습니다. 따라서 건강한 사람은 에너지 균형을 평형 상태로 유지하는 것이 중요하며, 이를 위해 1-2주의 기간 동안 식단과 운동을 조절해야 합니다."} 
        ```
        

# 2. 경진대회 수행 절차

- Step 1: 접근법 수립
- Step 2: 데이터 분석
- Step 3: 프롬프트 엔지니어링
- Step 4: 임베딩 모델 고도화
- Step 5: 역색인 + Vector 유사도 기반 검색 혼합
- Step 6: 역색인 기반 검색 성능 고도화

# 3. 경진대회 수행 과정

## 3.1. 접근법 수립

<aside>
💡 경진대회를 시작하기 전 학습 내용을 토대로 성능 향상을 위해 시도해볼 수 있는 접근법을 정리했다. 접근법은 크게 세 부분으로 나뉘며 정리된 순서에 따라 수행되어야 한다.

</aside>

1. 프롬프트 엔지니어링

- Goal: 질의 의도 분석 & function calling으로 standalone query 추출
    1. 질의 의도 분석 Instruction 
    - function 호출 여부 지시를 위해 지식 관련 질문인지 일반 대화인지 잘 구분하도록
    2. Function calling 함수 정의 
    - 역색인 기반 검색 시 standalone query를 문장보다는 키워드로 추출하는 것이 더 적합할 수 있음

2. 검색엔진 모델 고도화

- Goal: 임베딩 vector(dense vector) 기반 검색 성능 향상
    1. 고성능 임베딩 모델(vector encoder) 사용
    2. 임베딩 모델 파인튜닝 
    - LLM으로 document에 대해 가상의 질문 생성하여 학습 데이터 구축한 뒤 파인튜닝

3. 후처리 

- Goal: 후보군 늘린 후 reranking 혹은 filtering
    1. 후보군 늘리기
        1. 단순 검색 사이즈 늘리기
        2. 역색인(sparse vector) & 임베딩 vector(dense vector) 기반 검색 동시 사용
        3. 여러 개의 standalone query 사용
    2. LLM을 사용해 여러 후보군 내에서 reranking, 적합하지 않은 결과 filtering 

## 3.2. 데이터 분석

<aside>
💡 앞서 정리한 접근법에 따라 올바른 방향으로 실험을 진행하려면 데이터 분석이 선행되어야 한다. 따라서 아래 사항을 중점적으로 살펴보았다.
1) LLM에 입력될 메시지 데이터는 쿼리 추출을 위한 키워드가 어떤 패턴으로 이루어져 있는가
2) 검색엔진에 색인될 문서 데이터는 어느 범위까지의 과학 상식을 커버하는가

</aside>

### eval.jsonl - LLM에 입력될 메시지 데이터

- 총 220개의 메시지 데이터 중 20개의 멀티턴 대화 및 20개의 일반 대화를 포함
    
    ⇒ 멀티턴 대화 메시지에 대해서는 검색에 적절한 쿼리를 추출한 뒤 관련 문서를 검색해야
    
        일반 대화 메시지에 대해서는 검색을 수행하지 않고 바로 응답을 생성해야 한다.
    
     ** 멀티턴 대화이면서 일반 대화인 메시지는 없다.
    
- 키워드 패턴 
⇒ 문서에 등장하는 키워드가 그대로 포함된 메시지와 동의어/유의어/간접 표현이 포함된 메시지가 고르게 존재한다.
    - 문서에 등장하는 키워드가 그대로 포함된 메시지
        
        > 아래 예시는 문서에 등장하는 ‘아세틸 콜린’과 ‘역할’이라는 키워드를 그대로 포함
        > 
        
        ```json
        # 메시지
        {"eval_id": 292, "msg": [{"role": "user", 
        		"content": "아세틸 콜린의 역할이 뭐야?"}]}
        
        # 관련 문서
        {"docid": "8eac310f-a32f-462b-8ca8-da7c8fcd41e7", "src": "ko_mmlu__high_school_biology__test", 
        		"content": "... 아세틸콜린은 일반적으로 시냅스 간극을 통해 전달되는 신호를 전달하는 역할을 합니다. ..."}
        ```
        
        ⇒ 역색인 기반 검색에 유리함
        
    - 동의어/유의어/간접 표현이 포함된 메시지
        
        > 아래 예시는 문서에 등장하는 ”도토리”, “토양” 등의 키워드 대신 ”열매”, “땅” 등의 키워드를 포함
        > 
        
        ```json
        # 메시지
        {"eval_id": 285, "msg": [{"role": "user", 
        		"content": "다람쥐가 열매를 땅에 묻는 행동이 나무에 미치는 영향은?"}]
        
        # 관련 문서
        {"docid": "b38604f4-94bd-4482-97df-7a768331558a", "src": "ko_ai2_arc__ARC_Challenge__test", 
        		"content": "다람쥐는... 이들은 주로 도토리를 수집하고 토양에 묻는 것으로 알려져 있습니다. 
        							  ...이는 숲 생태계의 다양성을 유지하는 데에 기여합니다. ..."}
        ```
        
        ⇒ 임베딩 vector 기반 검색에 유리함
        

### documents.jsonl - 검색엔진에 색인될 문서 데이터

- 자연 과학뿐만 아니라, 사회/인문/우주/기술/코딩/교육/의료 등 다양한 분야의 지식에 관한 문서를 포함
    
    > 아래 예시 문서는 사회 과학 관련 지식에 해당
    > 
    
    ```json
    {"docid": "fabd5549-84e5-4b45-8c6b-261773e3311a", "src": "ko_mmlu__human_aging__test", 
    		"content": "장수는 사회적 지원과 높은 수준의 강한 관련이 있습니다. 
    							  사회적 지원은 개인이나 집단이 사회적으로 안정되고 안전한 환경에서 살 수 있도록 도와주는 요소입니다. 
    							  이는 경제적인 지원, 교육, 의료, 주거 등 다양한 형태로 제공될 수 있습니다. ..."}
    ```
    
    ⇒ 즉, 자연 과학에 국한되지 않은 다양한 주제의 지식 관련 메시지에 대해 검색을 수행해야 함
    

### 검증 데이터셋 구축

- 220개의 평가 데이터 중 60개를 샘플링한 뒤 정답 문서 ID를 라벨링하여 검증 데이터셋을 구축함으로써 로컬에서 MAP 스코어를 계산해볼 수 있도록 했다.
    - 정답 문서 ID는 추출된 쿼리에 대한 Sparse & Dense Retrieval의 top 10 결과를 토대로 선정

## 3.3. 프롬프트 엔지니어링

<aside>
💡 프롬프트 엔지니어링을 첫 번쨰 접근 단계로 둔 이유는 다음과 같다.
- 프롬프트를 통해 지식 관련 대화와 일반 대화를 구분하여 검색 수행 여부를 정확하게 판단해야 한다.
- 얼마나 적절한 쿼리를 추출하는가가 검색 성능에 큰 영향을 미칠 것이다.

</aside>

### persona_function_calling

```python
# RAG 구현에 필요한 질의 분석 및 검색 이외의 일반 질의 대응을 위한 LLM 프롬프트
persona_function_calling = """
## Role: 과학 상식 전문가

## Instruction
- 사용자가 대화를 통해 과학 지식에 관한 주제로 질문하면 search api를 호출할 수 있어야 한다.
- 과학 상식과 관련되지 않은 나머지 대화 메시지에는 적절한 대답을 생성한다.
"""
```

- 프롬프트 역할
    - 질의 의도 분석 & 일반 대화 메시지 대응
- Goal
    1. 지식과 관련된 메시지에 대해 search 함수를 호출하고 적절한 standalone query를 추출해야 한다. 
    2. 지식과 관련 없는 일반 대화에 대해 search 함수를 호출하지 않고 적절한 대답을 생성해야 한다.
- Baseline의 문제
    1. 지식 관련 메시지에 대해 search 함수가 호출되지 않음 → standalone_query 추출되지 않음
    
    ```json
    # eval.jsonl
    {"eval_id": 98, "msg": [
    	{"role": "user", "content": "은하들이 점점 멀어지고 있다던데 맞아?"}, 
    	{"role": "assistant", "content": "네 맞아요."}, 
    	{"role": "user", "content": "어떤 물리적인 현상을 보고 그걸 알게 되었어?"}
    ]}
    
    # sample_submission.csv
    {"eval_id": 98, "standalone_query": "", "topk": [], ...}
    ```
    
    1. 일반 대화 메시지임에도 불구하고 search 함수를 호출 → standalone_query 추출
    
    ```json
    # eval.jsonl
    {"eval_id": 276, "msg": [{"role": "user", "content": "요새 너무 힘들다."}]}
    
    # sample_submission.csv
    {"eval_id": 276, "standalone_query": "과학 상식", "topk": ["a089a668-da0e-4abc-bd7f-5762d55e1d20", "a7058a3b-285f-4466-a267-f864796ee77a", "e6777a84-144b-47db-b69c-d2125f1574c7"], ...}
    ```
    
- 프롬프트 수정
    
    ```python
    persona_function_calling = """
    ## Role: 과학 상식 전문가
    
    ## Instruction
    - 사용자가 지식에 관해 질문하는 경우에는 반드시 search 함수를 호출한다.
    - 나머지 메시지에는 함수 호출 없이 적절한 대답을 생성한다.
    """
    ```
    
    1. “과학 지식에 관한” → “지식에 관해”로 수정
        
        : 자연 과학뿐만 아니라 색인 문서 데이터가 커버하는 모든 지식에 관련된 질문을 모두 처리하도록
        
    2. “반드시” 추가
        
        : 지식 관련 메시지임에도 search 함수가 호출되지 않는 문제 해결
        
    3. “함수 호출 없이” 추가
        
        : search 함수 호출하지 않아야 하는 메시지(일반 대화 메시지)임에도 함수 호출되는 문제 해결
        
- 결과
    - 100%의 정확도(Accuracy = 1)로 질의 의도를 정확하게 분류

### fuction calling - standalone_query 정의

```python
# Function calling에 사용할 함수 정의
tools = [
    {
        "type": "function",
        "function": {
            "name": "search",
            "description": "search relevant documents",
            "parameters": {
                "properties": {
                    "standalone_query": {
                        "type": "string",
                        "description": "Final query suitable for use in search from the user messages history"
                    }
                },
                "required": ["standalone_query"],
                "type": "object"
            }
        }
    },
]
```

- 프롬프트 역할
    - 지식 관련 대화 메시지로부터 검색에 적합한 쿼리 추출
- Goal
    - 검색 성능을 최대한 높일 수 있는 형태의 쿼리를 추출해야 한다.
- Baseline의 문제
    - 메시지를 과도하게 요약하여 중요한 키워드를 포함하지 않음
    
    ```python
    # eval.jsonl
    {"eval_id": 21, "msg": [
    	{"role": "user", "content": "다양한 책을 catalog화 하는 코드에서 class 정의 방법 알려줘."}
    ]}
    
    # sample_submission.csv
    { 
    	"eval_id": 21, 
    	"standalone_query": "class 정의 방법", 
    	"topk": ["c0645487-4d27-4153-8bd6-c6abc823b72e", "01b3d119-c0e1-4dcc-b5f4-9f57cd681f43", "7150c749-dff2-4bd5-90ff-ff1e1cda468b"], 
    	"answer": "클래스를 정의하는 방법은 프로그래밍 언어에 따라 다를 수 있지만... ",
    	"references": [
    		{"score": 0.0022734697, "content": "객체 지향 언어는 모든 엔티티가 객체인 언어입니다. 이 언어에서는 두 가지 관계가 발생합니다. 첫 번째는 객체와 해당 객체가 속한 클래스 사이의 관계인 인스턴스 관계입니다..."},
    		{"score": 0.0021750622, "content": "알파벳 순서를 고려할 때, 모든 대문자가 모든 소문자 앞에 온다는 것은 자바 프로그래밍 언어에서의 문자열 비교에 대한 규칙입니다. 이 규칙을 기반으로 한 선언인 String strA..."}, 
    		{"score": 0.0020844745, "content": "프로그래머는 도서관의 모든 책을 카탈로그화하는 프로그램을 설계하고 있습니다. 이를 위해 각 책의 특징을 저장하는 Book 클래스를 계획하고 있습니다. Book 클래스는 저자, 제목..."}
    	]
    }
    ```
    
- 프롬프트 수정
    
    ⇒ 최대한 많은 키워드를 포함하도록 수정
    
    1. "description": "User's question. Full message if the user message is single-turn."  
        
        ⇒ 싱글턴 메시지의 경우, user의 메시지를 그대로 쿼리로 추출하도록 
        
        ```python
        "parameters": {
        		"properties": {
        				"standalone_query": {
        						"type": "string",
                    "description": "User's question in Korean. Full message if the user message is single-turn."
        				}
            },
            "required": ["standalone_query"],
            "type": "object"
        }   
        ```
        
        - **결과** - 의도한 대로 메시지 그대로 추출되지는 않으나 더 많은  키워드를 포함
        
        ```python
        {
        	"eval_id": 21, 
        	"standalone_query": "다양한 책을 catalog화 하는 코드에서 class 정의 방법", 
        	"topk": ["7150c749-dff2-4bd5-90ff-ff1e1cda468b", "01b3d119-c0e1-4dcc-b5f4-9f57cd681f43", "cd9feae5-13b2-4614-8524-a69814c6d49c"],
        }
        ```
        
    2. parameter 이름 : “standalone_query” → “question”
        
        ⇒ 단어의 나열보다는 질문 형식 그대로 추출하도록
        
        ```python
        "parameters": {
        		"properties": {
        				"question": {
        						"type": "string",
                    "description": "User's question in Korean. Full message if the user message is single-turn."
        				}
            },
            "required": ["question"],
            "type": "object"
        }    
        ```
        
        - **결과** - 질문 형식 그대로 추출되면서 더 많은 키워드를 포함
        
        ```python
        # parameter 이름 : "standalone_query"
        {"eval_id": 78, "standalone_query": "나무의 분류 방법", "topk": ["c63b9e3a-716f-423a-9c9b-0bcaa1b9f35d", "c18592d1-12b6-4d45-9fcd-efbdd6d7b016", "8018337f-15cb-4341-b6fa-e311b4372df9"], "answer": "", "references": [{"score": 13.007582, "content": "한 학생이 다양한 종류의 나무를 조사하고 있습니다. 이 학생은 성장 속도, 온도 범위, 크기가 비슷한 두 나무를 발견했습니다. 그러나 이 두 나무의 잎과 꽃은 서로 다릅니다. 이러한 특징을 고려하면, 이 나무들은 대체로 같은 속에 속해 있을 것으로 추측됩니다. 같은 속에 속한 나무들은 종류별로 유사한 특징을 가지고 있으며, 이는 생물 분류학에서 중요한 기준 중 하나입니다. 따라서 이 학생의 조사 결과는 나무의 분류와 관련된 중요한 정보를 제공할 수 있습니다. 이러한 조사는 나무의 성장과 생태에 대한 이해를 높이는 데 도움이 될 것입니다."}, {"score": 11.53242, "content": "별은 많은 다른 방법으로 분류할 수 있습니다. 이 중에서 별을 분류하는 데 가장 유용하지 않은 것은 표면 질감입니다. 별은 종종 밤하늘에서의 겉보기 밝기로 분류됩니다. 그러나 표면 질감은 별을 분류하는 데에는 유용하지 않습니다. 표면 질감은 별의 물리적 특성과는 관련이 없으며, 별의 분류에는 다른 요소들이 더 중요합니다. 예를 들어, 별의 크기, 온도, 스펙트럼 등이 별을 분류하는 데에 더 유용한 정보를 제공합니다. 따라서 표면 질감은 별을 분류하는 데에는 가장 유용하지 않은 방법입니다."}, {"score": 11.24757, "content": "나무는 재생 가능한 에너지원으로 간주됩니다. 이는 나무가 석탄이 형성되는 것보다 빠르게 자라기 때문입니다. 나무는 태양 에너지를 흡수하여 광합성을 통해 자라납니다. 이 과정에서 나무는 이산화탄소를 흡수하고 산소를 방출합니다. 이러한 특성으로 인해 나무는 지속적으로 재생되는 에너지원으로 사용될 수 있습니다. 반면, 석탄은 수백만 년 동안 지속적인 압력과 열에 노출되어 형성됩니다. 석탄은 화석 연료로 분류되며, 한 번 사용되면 재생되지 않습니다. 따라서 나무는 석탄보다 더욱 지속 가능한 에너지원으로 간주됩니다."}]}
        {"eval_id": 280, "standalone_query": "Dmitri Ivanovsky", "topk": [], "answer": "", "references": []}
        {"eval_id": 238, "standalone_query": "전류의 흐름을 극대화하는 방법", "topk": ["fe188a5b-54f1-4c02-a79f-598c8d303082", "3418f00c-20cc-4780-8614-a2cf42b92dff", "5d2ea84a-3cc5-4f5e-849b-bc9b2d31d579"], "answer": "", "references": [{"score": 13.644601, "content": "이상적인 인덕터에서의 전력 손실은 0이다. 인덕터는 전기 회로에서 사용되는 중요한 장치로, 전기 에너지를 저장하고 전류를 변환하는 역할을 한다. 이상적인 인덕터는 내부 저항이 없으며, 전기 에너지를 완전히 저장하고 변환하는 능력을 가지고 있다. 따라서, 이상적인 인덕터에서는 전력 손실이 발생하지 않는다. 이는 전력 효율성을 높이고 전기 회로의 안정성을 유지하는 데 중요한 역할을 한다. 이상적인 인덕터의 존재는 이론적인 개념이지만, 실제 인덕터의 설계와 제작에서는 최대한 이상적인 상태에 가깝도록 노력한다. 이를 통해 전력 손실을 최소화하고 전기 시스템의 효율성을 극대화할 수 있다."}, {"score": 13.48374, "content": "상업용 항공기의 72W navigation unit은 24V의 전력 공급원과 3A의 전류를 사용합니다. 이 navigation unit의 전기 저항은 8옴입니다. 전기 저항은 전압과 전류의 비율로 정의되며, 이 경우에는 24V의 전압과 3A의 전류로 계산되었습니다. 전기 저항은 전기 회로에서 전류의 흐름을 제한하는 역할을 합니다. 따라서, 이 navigation unit은 24V의 전압과 3A의 전류로 작동하며, 전기 저항을 통해 안정적인 전류 흐름을 유지합니다."}, {"score": 13.327515, "content": "dynamometer wattmeter의 가동 코일 내 회로의 저항은 높아야 한다. 이는 정확한 전력 측정을 위해 필요한 조건이다. 높은 저항은 전류의 흐름을 제한하여 측정 오차를 최소화한다. 또한, 높은 저항은 가동 코일에 인가되는 전압을 안정화시켜 정확한 측정 결과를 얻을 수 있도록 한다. 따라서, dynamometer wattmeter의 가동 코일 내 회로의 저항은 높아야 한다."}]}
        {"eval_id": 20, "standalone_query": "소프트웨어 개발과 편향", "topk": ["ad5d883f-4352-4d25-ba7b-cbb605c73662", "9081f170-07e2-4a15-b72f-9bb2222efac2", "1cce9c2a-3219-42fa-87b3-766b36df4cc2"], "answer": "", "references": [{"score": 14.222359, "content": "현재(2018년 기준) 미국 내 성인 중 약 58%의 사람들이 컴퓨터 프로그램이 인간의 편향성을 항상 반영할 것이라고 믿고 있습니다. 이는 컴퓨터 프로그램이 인간의 편향성을 반영할 수 있다는 점에 대한 인식이 높아진 결과입니다. 컴퓨터 프로그램은 인간이 만들기 때문에, 그 안에는 우리의 편향성이 반영될 수 있습니다. 이러한 인식은 컴퓨터 프로그램의 개발과 사용에 있어서 중요한 문제로 다뤄져야 합니다."}, {"score": 14.09243, "content": "입력이 제어 하위 시스템에 미치는 영향을 알려주는 상자를 Decision box라고 한다. Decision box는 소프트웨어 개발 과정에서 중요한 역할을 한다. 이 상자는 결정을 내리는 데 도움을 주는 도구로 사용된다. 개발자는 입력에 따라 다른 경로를 선택할 수 있으며, 이를 통해 시스템의 동작을 제어할 수 있다. Decision box는 주로 흐름도나 프로세스 다이어그램에서 사용되며, 각각의 입력에 대한 결과를 나타내는 화살표로 연결된다. 이를 통해 개발자는 시스템의 동작을 예측하고, 필요한 조치를 취할 수 있다. 따라서 Decision box는 소프트웨어 개발 과정에서 필수적인 요소로 간주된다."}, {"score": 13.6296625, "content": "컴파일러는 실행 가능한 소프트웨어를 개발하는 과정에서 매우 중요한 역할을 수행합니다. 이는 추상적인 고급 언어로 작성된 프로그램을 동일한 동작을 표현하는 기계 코드로 번역하는 역할을 맡고 있습니다. 컴파일러는 프로그래머가 작성한 코드를 분석하고, 문법적인 오류를 검출하며, 최적화 기법을 적용하여 실행 속도를 향상시킵니다. 또한, 컴파일러는 프로그램의 구조를 분석하여 메모리 할당과 같은 중요한 작업을 수행합니다. 이러한 과정을 통해 컴파일러는 프로그래머가 작성한 코드를 기계가 이해할 수 있는 형태로 변환하여 실행 가능한 소프트웨어를 생성합니다. 따라서, 컴파일러는 소프트웨어 개발 과정에서 필수적인 도구로 사용되며, 프로그램의 성능과 효율성을 향상시키는 역할을 담당합니다."}]}
        
        # parameter 이름 : "question"
        {"eval_id": 78, "standalone_query": "나무의 분류에 대해 조사해 보기 위한 방법은?", "topk": ["c63b9e3a-716f-423a-9c9b-0bcaa1b9f35d", "db5a52c1-c3a4-4693-ac15-6e1bec041e98", "11046b98-c0e8-44d9-8187-c7417c2b991b"], "answer": "", "references": [{"score": 0.0053798053, "content": "한 학생이 다양한 종류의 나무를 조사하고 있습니다. 이 학생은 성장 속도, 온도 범위, 크기가 비슷한 두 나무를 발견했습니다. 그러나 이 두 나무의 잎과 꽃은 서로 다릅니다. 이러한 특징을 고려하면, 이 나무들은 대체로 같은 속에 속해 있을 것으로 추측됩니다. 같은 속에 속한 나무들은 종류별로 유사한 특징을 가지고 있으며, 이는 생물 분류학에서 중요한 기준 중 하나입니다. 따라서 이 학생의 조사 결과는 나무의 분류와 관련된 중요한 정보를 제공할 수 있습니다. 이러한 조사는 나무의 성장과 생태에 대한 이해를 높이는 데 도움이 될 것입니다."}, {"score": 0.0041792444, "content": "벌목 회사는 숲의 나무를 베어내어 숲에서 멀리 떨어진 목재 공장으로 보냅니다. 이 목재 공장은 건설에 사용되는 판자를 만들어 공급합니다. 그러나 일부 벌목 회사들은 나무를 베어낸 후에 나무 씨앗을 심지 않습니다. 이는 미래에 판자가 필요한 사람들에게 영향을 미칠 수 있습니다. 왜냐하면 판자의 가격이 상승할 것이기 때문입니다.\n\n나무는 우리 생활에 매우 중요한 자원입니다. 우리는 나무를 사용하여 집을 지을 수 있고, 가구를 만들 수 있으며, 열을 낼 수 있습니다. 그러나 나무는 자연에서 재생되는데 시간이 걸립니다. 벌목 회사들이 나무를 베어내고 나무 씨앗을 심지 않으면, 나무의 재생이 어려워집니다.\n\n판자는 건설에 필요한 중요한 자재입니다. 건물을 지을 때 판자는 필수품입니다. 그러나 판자의 수요가 증가하면서 판자의 가격도 상승하고 있습니다. 이는 나무를 베어내고 나무 씨앗을 심지 않는 벌목 회사들의 행동과 관련이 있습니다. 나무의 수요가 증가하면서 나무의 공급이 부족해지고 있기 때문에 판자의 가격이 상승하는 것입니다.\n\n나무 씨앗을 심는 것은 나무의 재생을 도와줍니다. 나무 씨앗을 심으면 나무가 자라고 번식할 수 있습니다. 이는 나무의 공급을 유지하고 판자의 가격을 안정시키는 데 도움이 됩니다. 따라서 벌목 회사들은 나무를 베어내는 것과 동시에 나무 씨앗을 심어야 합니다.\n\n미래에 판자가 필요한 사람들은 벌목 회사들의 행동에 영향을 받을 수 있습니다. 판자의 가격이 상승하면 건설 비용이 증가하고, 집을 짓는 데 더 많은 비용이 들게 됩니다. 또한 가구를 만드는 데에도 더 많은 비용이 들게 됩니다. 이는 사람들의 생활에 직접적인 영향을 미칠 수 있습니다.\n\n따라서 벌목 회사들은 환경 보호와 나무의 재생을 위해 나무 씨앗을 심어야 합니다. 이는 미래에 판자가 필요한 사람들에게도 긍정적인 영향을 미칠 것입니다. 판자의 가격이 안정되고, 건설 비용이 감소하며, 자원을 보호하는 데에도 도움이 될 것입니다."}, {"score": 0.004117165, "content": "숲에서 쓰러진 나무를 제거하는 것은 화재 위험을 줄이기 위한 중요한 조치입니다. 그러나 이제 나무를 제거하는 것이 숲의 상태에 영향을 미칠 것으로 생각됩니다. 숲에서 쓰러진 나무는 영양분을 포함하고 있으며, 이 영양분은 토양의 비옥성을 유지하는 데 중요한 역할을 합니다. 따라서 숲에서 쓰러진 나무를 제거하면 영양분의 재활용이 방해되어 토양의 비옥성이 감소할 수 있습니다. 이는 숲 생태계에 부정적인 영향을 미칠 수 있으며, 숲의 생물 다양성과 생태계의 안정성을 위협할 수 있습니다. 따라서 숲에서 쓰러진 나무를 제거할 때에는 이러한 영향을 고려하여 신중한 판단이 필요합니다."}]}
        {"eval_id": 280, "standalone_query": "Dmitri Ivanovsky가 누구야?", "topk": ["9b7bc48a-6e0c-450c-8364-a7da2ac4d4d4", "dd8a41b4-024e-4d2d-a687-28e057634d4e", "61e22317-2240-4aaf-9498-917e23f4466e"], "answer": "", "references": [{"score": 0.0025070577, "content": "벽돌공의 아들은 대학에 진학하여 의과 대학에서 교사가 되었습니다. 그리고 시간이 흐르면서 그는 종신 교수로 승진하였습니다. 그러나 그의 열정은 그것으로 끝나지 않았습니다. 그는 다른 학교에서의 새로운 종신 교수 직위를 위해 전국을 이동하였습니다. 이렇게 순차적으로, 이 남자는 아버지에 대한 세대 간 이동, 상향 이동, 수평 이동 등 다양한 경험을 하였습니다. 그의 열정과 노력 덕분에 그는 자신의 꿈을 이루었고, 많은 사람들에게 영감을 주었습니다."}, {"score": 0.002493044, "content": "프란시스 갈튼은 청년과 노인의 반응 시간을 측정하고 비교한 최초의 사람입니다. 그는 19세기 말에 이 연구를 수행하여 청년과 노인의 반응 시간에 차이가 있다는 것을 발견했습니다. 이 연구는 인간의 인지 능력과 노화 과정에 대한 이해를 높이는 데에 큰 기여를 하였습니다. 프란시스 갈튼의 연구는 그 후 많은 연구자들에 의해 확장되어 현재까지도 많은 관심을 받고 있습니다. 그의 연구는 우리가 나이에 따른 인지 능력의 변화를 이해하는 데에 중요한 역할을 하였습니다."}, {"score": 0.0024109697, "content": "라마르크의 유전학 이론은 19세기에 제시되었습니다. 라마르크는 환경 변화에 따라 생물체의 특성이 변화할 수 있다고 주장했습니다. 이에 따라 1900년대 중반, 소련의 유전학자 리센코는 라마르크의 이론을 참고하여 가을밀의 특성 변화를 연구했습니다. 리센코는 점점 더 낮은 온도에 노출된 가을밀 식물이 결국 점점 더 추위에 강한 가을밀을 번식할 것이라고 믿었습니다. 이러한 시도는 라마르크의 아이디어와 가장 일치합니다."}]}
        {"eval_id": 238, "standalone_query": "전류의 흐름을 극대화 하려면 배터리와 저항을 어떻게 연결해야 하나?", "topk": ["f48600d6-e492-43eb-b564-1860aa81da5f", "84934dd1-81ad-4bb1-95e0-ccf02d38b49b", "185008d2-6091-4beb-94e4-d847d70fdea6"], "answer": "", "references": [{"score": 0.0062105497, "content": "고전압 배터리와 저항기를 직렬로 연결하면 가장 큰 전류를 만들 수 있는 회로를 구성할 수 있습니다. 직렬 연결은 배터리와 저항기가 한 줄로 연결되는 구성을 말합니다. 이 구성에서는 배터리의 전압이 저항기에 모두 걸리기 때문에 전류가 최대로 흐를 수 있습니다. 따라서, 저항이 직렬로 배치된 고전압 배터리를 사용하면 가장 큰 전류를 만들 수 있는 회로를 만들 수 있습니다."}, {"score": 0.0045290417, "content": "정상적으로 작동하는 전기 회로의 전선에서는 어떤 변화가 일어날까요?\n\n전선은 더 따뜻해질 것입니다.\n\n전기 회로가 정상적으로 작동할 때, 전선에서는 일부 변화가 일어납니다. 전선은 전기 에너지를 전달하기 위한 역할을 수행하며, 전류가 흐르는 동안 일정한 저항을 가지고 있습니다. 따라서 전선은 전류가 흐를 때 일부 열을 발생시키며, 이는 전선이 더 따뜻해지는 현상을 초래합니다.\n\n전선이 더 따뜻해진다는 것은 전기 에너지가 전선을 통해 흐르고 있다는 증거입니다. 전선의 내부에서는 전자들이 전류를 형성하며, 이 전자들은 전기 에너지를 운반하는 역할을 합니다. 전선의 저항은 전류의 흐름을 제한하고, 이에 따라 일부 전기 에너지가 열로 변환됩니다. 따라서 전선은 전류가 흐를 때 일정한 온도로 유지되지만, 전류가 증가하면 전선의 온도도 상승하게 됩니다.\n\n전선이 더 따뜻해진다는 것은 전기 회로가 정상적으로 작동하고 있다는 증거입니다. 전선의 온도는 전류의 크기와 저항에 따라 달라지며, 이를 통해 전기 회로의 상태를 파악할 수 있습니다. 따라서 전선이 더 따뜻해진다면, 전기 회로가 정상적으로 작동하고 있음을 알 수 있습니다."}, {"score": 0.004507352, "content": "연결선의 전류는 LED 램프의 전류와 같습니다. 이는 전기 회로의 기본 원리에 따라 전류는 회로를 따라 일정하게 흐르기 때문입니다. 따라서, LED 램프와 연결선 사이의 전류는 동일합니다. 이는 안전하고 효율적인 전기 회로를 구성하는 중요한 요소입니다."}]}
        {"eval_id": 20, "standalone_query": "소프트웨어 개발이 사람의 편향없이 이루어질 수 있나?", "topk": ["5c0b801f-67ca-4ca3-a97e-8cd743b8b436", "ec87a926-171d-4f62-9acc-1b870c010a16", "b1687285-28e7-4191-ad0b-a8a36fa5665e"], "answer": "", "references": [{"score": 0.002703646, "content": "대형 자바 프로그램은 광범위하게 테스트되었으며, 이 과정에서 어떠한 오류도 발견되지 않았습니다. 이러한 결과를 토대로 결론을 내릴 수 있습니다. 하지만, 프로그램이 오류가 없다고 해서 완전히 버그가 없다고 단정할 수는 없습니다. 테스트 과정에서 발견되지 않은 오류가 나중에 발생할 수도 있으며, 사용자의 다양한 환경에서 예기치 않은 문제가 발생할 수도 있습니다. 따라서, 프로그램을 계속해서 모니터링하고 향후 발생할 수 있는 문제에 대비하는 것이 중요합니다. 프로그램의 안정성과 신뢰성을 유지하기 위해 지속적인 테스트와 개선 작업이 필요합니다."}, {"score": 0.002620951, "content": "평균을 찾는 알고리즘은 평균 = 합계 / N이며, 여기서 N과 합계는 모두 정수입니다. 이 알고리즘을 사용하는 프로그램에서 프로그래머가 N이 0인지 확인하는 테스트를 포함하는 것을 잊었습니다. N이 0인 경우, 오류는 실행 시간 동안 감지됩니다. 프로그램이 실행되는 동안, 알고리즘은 N이 0인지 확인하고, 만약 N이 0이라면 오류를 감지하고 적절한 예외 처리를 수행합니다. 이렇게 함으로써 프로그램은 잘못된 입력에 대해 안정적으로 처리할 수 있습니다. 따라서, 프로그램이 실행되는 동안 N이 0인 경우 오류가 감지되고 처리됩니다."}, {"score": 0.002591967, "content": "한 과학자는 직장 스트레스가 인간의 심장 질환에 미치는 영향을 연구했습니다. 이 연구에서는 자신들의 일이 매우 스트레스가 많다고 하는 남성들과 그렇지 않다고 하는 남성들을 두 그룹으로 나누어 조사했습니다. 연구 기간 동안, 과학자는 각 남성의 심장 건강을 추적 관찰했습니다. 그러나 이 연구에서는 오직 남성만을 대상으로 테스트했기 때문에 여성의 심장 건강에 대한 결과는 알 수 없습니다. 이러한 편향은 연구 결과의 일반화에 제한을 가할 수 있습니다."}]}
        ```
        

<aside>
👉 프롬프트 엔지니어링 후 Public LB 스코어 - 0.6939(baseline) ⇒ 0.7485 : 약 0.05 상승

</aside>

## 3.4. 임베딩 모델 고도화 (dense retrieval)

<aside>
💡 baseline에서는 Elasticsearch를 사용해 역색인(sparse vector) 기반 검색만을 수행하며, 임베딩(dense vector) 기반 검색을 위한 함수를 제공하는 데역색인 기반 검색보다 성능이 낮다. 
그러나 앞선 데이터 분석을 통해 임베딩 기반 검색에 더 유리한 데이터가 다수 존재함을 확인했다. 따라서 임베딩 기반 검색에 사용되는 임베딩 모델(vector encoder)의 성능을 향상시켰을 때 역색인 기반 검색의 성능을 능가할 수 있는 여지가 있다고 판단했다. 
임베딩 모델 성능 향상을 위한 모델 고도화를 위해 1)고성능의 임베딩 모델을 찾고 2)LLM을 활용해 학습 데이터를 생성하여 파인튜닝을 시도했다.

</aside>

### 다양한 임베딩 모델(vector encoder) 실험

- Baseline: snunlp/KR-SBERT-V40K-klueNLI-augSTS
- SBERT 기반 모델 - baseline 모델 보다 높은 성능
    - hunkim/sentence-transformer-klue
    - jhgan/ko-sbert-sts
- RoBERTa 기반 모델 - 의미론적 유사도 예측 성능이 SBERT보다 높음
    - ddobokki/klue-roberta-base-nli-sts
    - jhgan/ko-sroberta-multitask - 가장 높은 성능
    - jhgan/ko-sroberta-sts

> 문서의 키워드가 paraphrased된 쿼리에 대해 sbert는 정답 문서를 검색하지 못하는 데 반해(topk = 3), RoBERTa 모델 임베딩 사용 시 정답 문서를 검색한다.
> 

```python
test_query = "지구가 생겨난지 얼마나 오래 되었는지 확인하는 방법은?"

# jhgan/ko-sbert-sts
score: 0.0039065317 source: 행성년의 원인을 모델링하기 위해 과학자들은 행성이 태양으로부터 떨어져 있는 거리를 사용합니다. 이 거리는 행성이 태양 주위를 돌면서 받는 태양의 복사 에너지의 양을 결정합니다. 행성이 태양으로부터 멀어질수록 태양의 복사 에너지는 감소하게 되고, 이는 행성의 온도와 기후에 영향을 미칩니다. 따라서, 행성년의 원인을 연구하는 과학자들은 이 거리를 중요한 변수로 고려하여 모델링을 진행합니다. 이를 통해 우리는 행성년의 원인과 행성의 환경 사이의 관계를 이해할 수 있습니다.
score: 0.0037860414 source: 우리 태양계의 기원에 대한 이론은 수년 동안 많은 천문학자들의 연구와 논의를 거쳐 왔습니다. 오랜 기간 동안, 우리 태양계가 천천히 응축되는 먼지와 가스의 구름에서 형성되었다는 가설이 주류였습니다. 그러나 최근의 연구 결과는 이 가설을 수정할 필요가 있음을 시사하고 있습니다.새로운 증거는 우리 태양계가 성운에서 단명하는 거대한 별들이 폭발할 때 형성되었을 수 있다는 가능성을 제시합니다. 이는 기존의 가설과는 다른 접근 방식이며, 우리 태양계의 기원에 대한 새로운 시각을 제시합니다...
score: 0.0037348438 source: 수성은 태양계에서 가장 작은 행성 중 하나입니다. 이 작은 행성은 영구적인 대기 부재를 가지고 있지 않습니다. 그렇다면, 수성의 영구적인 대기 부재를 설명하지 못하는 메커니즘은 무엇일까요? 그것은 화산활동에 의한 가열입니다. 수성의 표면에는 많은 화산이 있으며, 이러한 화산들은 지속적으로 분출되는 열을 생성합니다. 이 열은 수성의 대기를 형성하는 데 충분하지 않습니다. 따라서, 수성은 영구적인 대기 부재를 가지고 있지 않습니다.
 
# jhgan/ko-sroberta-multitask
score: 0.013622982 source: 지구의 나이를 알아내는 방법은 바위와 운석의 방사성 연대 측정을 통해 알 수 있습니다. 바위와 운석은 지구의 역사를 담고 있는 증거들이며, 그들은 오랜 세월 동안 방사성 동위원소를 분해하여 안정 동위원소로 변화합니다. 이러한 방사성 붕괴 과정은 시간이 지남에 따라 예측 가능한 속도로 진행되므로, 바위와 운석의 방사성 연대 측정을 통해 그들의 나이를 알아낼 수 있습니다. 이러한 연구는 지구의 진화와 지질학적 역사를 이해하는 데 매우 중요한 역할을 합니다. 바위와 운석의 방사성 연대 측정은 과학적인 방법으로 수행되며, 다양한 기술과 기기를 사용하여 정확한 결과를 얻을 수 있습니다. 이러한 연구는 우리가 현재의 지구의 상태를 이해하고 미래를 예측하는 데 도움을 줄 수 있습니다.
score: 0.011032162 source: 태양계는 대략 46억 년 전에 형성되었습니다. 이는 운석 연구를 통해 밝혀진 사실입니다. 태양계의 나이가 이렇게 오래된 이유는 태양계의 형성 단계에서 많은 운석들이 형성되었기 때문입니다. 이러한 운석들은 우리에게 태양계의 역사와 진화에 대한 중요한 정보를 제공합니다. 태양계의 나이를 알아내는 것은 우주 과학 연구에 있어서 매우 중요한 역할을 합니다. 이를 통해 우리는 태양계의 형성과 진화에 대한 이해를 더욱 깊이 있게 할 수 있습니다.
score: 0.010985054 source: 라이엘과 다윈의 시대 이전에는 지구는 수천 년 된 것이며, 인구는 변하지 않는다는 개념이 지배적이었습니다. 이 시대에는 인류가 살아가는 동안 지구의 형태와 인구의 수는 변하지 않는다고 믿어졌습니다. 이 개념은 고대 철학자들에 의해 주장되었으며, 그들은 지구가 고대부터 존재하며 인구는 일정하게 유지된다고 믿었습니다. 이러한 개념은 자연의 균형과 안정성을 강조하며, 인간의 힘과 영향력을 상대적으로 작게 보는 철학적인 시각을 반영하고 있습니다. 그러나 라이엘과 다윈의 시대 이후에는 지구의 역사와 인구의 변화에 대한 새로운 이해가 발전하였습니다.
```

### 임베딩 모델 파인튜닝

- 파인튜닝 방식
    - LLM으로 각 document에 대해 가상의 질문 3개씩 생성하여 학습 데이터를 구축한 뒤 파인 튜닝하는 방식
- Step1. Question Generation
    - OpenAI gpt-3.5-turbo-1106 모델 사용
        
        ```python
        # 질문 생성 프롬프트
        augment_instruct = """
        ## Role
        가상 데이터 생성기
        
        ## Instructions
        - 주어진 지문의 내용에서 답변을 찾을 수 있는 짧은 질문을 한국어로 3개 생성해줘.
        - 예시 
        지문: 물이 구름에서 다시 지구로 떨어질 때, 강수라는 현상이 일어납니다. 강수는 물의 순환 과정 중 하나로, 구름 안에 있는 수증기가 높은 고도에서 낮은 고도로 이동하면서 물방울로 변합니다. 이 물방울들은 구름 안에서 충돌하고 서로 합쳐져서 점점 커지게 됩니다. 그리고 어느 정도 크기가 되면 중력에 의해 지구로 떨어지게 됩니다. 이렇게 물이 구름에서 지구로 떨어지는 과정을 강수라고 합니다. 강수는 비, 눈, 우박 등 다양한 형태로 나타날 수 있으며, 지구의 생태계와 물의 순환에 중요한 역할을 합니다.
        질문: 빗방울이 점점 커지게 되는 요인은?
        - 아래 JSON 포맷으로 생성해줘.
        
        ## Output format
        {"questions": [$question1, $question2, $question3]}
        """
        ```
        
    - 생성 예시
        
        ```python
        sample = """
        프로그래머는 도서관의 모든 책을 카탈로그화하는 프로그램을 설계하고 있습니다. 
        이를 위해 각 책의 특징을 저장하는 Book 클래스를 계획하고 있습니다…"""
        
        # result
        {"questions": [
        		"프로그래머가 Book 클래스에 어떤 속성을 포함할 계획인가요?", 
        		"LibraryList 클래스는 어떤 기능을 수행할 수 있나요?", 
        		"프로그래머가 상향식 개발 방법을 사용하는 이유는 무엇인가요?"
        ]}
        ```
        
- Step2.  query + document pair 생성 (positive & negative)
    - 생성한 question, 해당 document, source 정보(domain)로 구성된 json 데이터 생성 (4272 x 3 = 12816개)
        
        ```python
        	{
        			"id": 0, 
        			"question": "건강한 식단은 어떻게 구성되어야 하는가?", 
        			"content": "건강한 사람이 에너지 균형을 평형 상태로 유지하는 것은 중요합니다. 에너지 균형은 에너지 섭취와 에너지 소비의 수학적 동등성을 의미합니다. 일반적으로 건강한 사람은 1-2주의 기간 동안 에너지 균형을 달성합니다. 이 기간 동안에는 올바른 식단과 적절한 운동을 통해 에너지 섭취와 에너지 소비를 조절해야 합니다. 식단은 영양가 있는 식품을 포함하고, 적절한 칼로리를 섭취해야 합니다. 또한, 운동은 에너지 소비를 촉진시키고 근육을 강화시킵니다. 이렇게 에너지 균형을 유지하면 건강을 유지하고 비만이나 영양 실조와 같은 문제를 예방할 수 있습니다. 따라서 건강한 사람은 에너지 균형을 평형 상태로 유지하는 것이 중요하며, 이를 위해 1-2주의 기간 동안 식단과 운동을 조절해야 합니다.", 
        			"domain": "ko_mmlu__nutrition__test"
        	}
        ```
        
    - domain 정보를 기준으로 1 Positive Pair + 15 Negative Pair (10 Hard Negative, 5 Soft Negative)를 생성하여 학습 데이터 구축 (12816 x 16개)
        
        ```python
        same_domain_desc_list = pd.unique(data[data['domain']==domain]['content'])
        other_domain_desc_list =  pd.unique(data[data['domain']!=domain]['content'])
        
        # Positive Pair 
        query.append(q)
        doc.append(d)
        label.append(1)
        
        # Negative Pair
         # Hard - 같은 도메인 내의 문서(모델이 정답으로 착각하기 쉬운 문서)와 pairing 
        negative_sample_count = 10 if len(same_domain_desc_list) >= 10 else len(same_domain_desc_list)
        desc_list_sample = random.sample(list(same_domain_desc_list), k=negative_sample_count)
        for dl in desc_list_sample:
            if d == dl: continue
            else: 
                query.append(q)
                doc.append(dl)
                label.append(-1)
            
         # Soft - 다른 도메인에 속한 문서와 pairing
        other_desc_list_sample = random.sample(list(other_domain_desc_list), 5)
        for dl in other_desc_list_sample:
            query.append(q)
            doc.append(dl)
            label.append(-1)
        ```
        
- Step3. 모델 파인튜닝
    - jhgan/ko-sbert-sts, jhgan/ko-sroberta-multitask
    
    ```python
    train_loss = losses.CosineSimilarityLoss(model)
    model.fit(train_objectives=[(train_dataloader, train_loss)], epochs=1, warmup_steps=100)
    ```
    
- 결과
    - **파인튜닝 전보다 임베딩 vector 기반 검색 성능 하락**
    - 이유 분석
        - LLM으로 생성한 쿼리와 대회 평가 데이터에서 추출된 쿼리 간의 차이
            
            ⇒ 평가 데이터에서 추출된 쿼리는 동의어나 간접적인 표현으로 prarphrase되어 있는 경우가 많은 반면, LLM이 생성한 질문은 문서에 등장한 단어나 표현이 그대로 들어가 있는 편. ⇒ 직접적인 질문으로 구성된 학습 데이터에 오버피팅이 일어남.
            
        - 모델이 정답으로 착각학기 쉬운 Hard Negative 문서가 충분히 효과적으로 pairing되지 않음
    - 개선 방향
        - Question Generation 시 동의어 및 간접적인 표현을 포함한 질문을 생성하도록(또는 관련 키워드를 미리 생성한 뒤 해당 키워드를 포함한 질문을 생성하도록) 프롬프트를 수정하고 학습 데이터를 다시 구축하여 파인튜닝해볼 수 있다.
        - Hard Negative Pair 구축을 도메인 기준이 아닌 다른 방식으로 시도해볼 수 있다. 예: 도메인 기준이 아니라 Retrieval 결과 topk 중 샘플링하는 방법

## 3.5. sparse vector 기반 검색 + dense vector 기반 검색

<aside>
👉 jhgan/ko-sroberta-multitask 임베딩 모델을 사용한 dense vector 기반 검색보다 sparse vector 기반 검색 시 MAP 스코어가 여전히 높지만 sparse retrieval보다 dense retrieval 검색 시 성능이 더 좋은 쿼리가 다수 존재했다. 
따라서 sparse vector 기반 검색에 dense vector 기반 검색을 적절하게 혼합한다면 성능 향상을 기대할 수 있다고 판단했고, Elasticsearch의 쿼리 DSL을 사용하여 hybrid retrieval을 구현했다.

</aside>

### sparse retrieval보다 dense retrieval로 검색할 때 성능이 더 좋은 쿼리의 유형

- 문서의 키워드가 그대로 쿼리에 포함되지 않은 경우

```python
test_query = "세균의 순기능" 

# sparse retrieval
score: 11.097561 source: 세균 세포에 영향을 미치는 항생제는 다양한 방식으로 작용한다. 항생제는 세균의 세포벽을 파괴하거나 세포막의 투과성을 증가시키는 역할을 한다. 또한, 항생제는 세균의 단백질 합성을 억제하거나 핵산의 합성을 방해하여 세포의 기능을 교란시킨다. 그러나, 역전사는 항생제의 작용 방식 중 예외적인 경우이다. 역전사는 세균의 유전자를 역전사하여 단백질 합성을 억제하는데, 이는 항생제의 효과를 무효화시킬 수 있다. 따라서, 세균 세포에 영향을 미치는 항생제는 다양한 방식으로 작용하지만, 역전사는 예외적인 경우로 알려져 있다.
score: 9.509126 source: 바이러스 형질도입은 세균 진화에서 중요한 역할을 합니다. 이 과정은 바이러스가 한 세균 세포에서 다른 세균 세포로 세균 DNA를 운반하는 과정입니다. 바이러스는 세균에 감염되어 세균의 유전적 변이를 증가시킵니다. 이는 세균의 다양성을 증가시키고 새로운 특성을 얻을 수 있는 기회를 제공합니다. 세균은 이러한 유전적 변이를 통해 환경 변화에 대응하고 생존력을 향상시킬 수 있습니다. 따라서 바이러스 형질도입은 세균 진화에서 중요한 역할을 하며, 세균의 다양성과 적응력을 증가시키는데 기여합니다.
score: 9.3766 source: 세균은 무성 생식을 하는 유기체입니다. 이는 세균이 단일 부모로부터 새롭게 생산되는 것을 의미합니다. 세균은 유전자를 상속받는데, 이는 단일 부모와 같은 특성을 가지게 됩니다. 세균은 유전자의 조합을 통해 다양한 특성을 가질 수 있으며, 이는 세균의 다양성과 적응력을 높여줍니다. 세균은 빠른 성장과 번식 능력으로 인해 환경에서 매우 중요한 역할을 합니다. 세균은 다양한 환경에서 생존할 수 있으며, 이는 세균의 유전적 다양성과 적응력에 기인합니다. 세균은 우리 주변에 많이 존재하며, 우리의 건강에도 영향을 미칩니다. 세균의 특성을 이해하고 관리하는 것은 우리의 건강과 생활에 매우 중요합니다.
# dense retreival 
score: 0.015227599 source: 세균은 다양한 방식으로 인체에 도움을 줄 수 있습니다. 대표적으로, 세균은 음식을 분해하는 데 도움을 줍니다. 세균은 소화 과정에서 음식물을 분해하여 영양소를 생성하고 흡수를 도와줍니다. 이를 통해 우리 몸은 필요한 영양소를 효과적으로 흡수할 수 있습니다. 따라서, 세균은 우리 인체와 환경에 많은 도움을 주는 중요한 존재입니다.
score: 0.013073802 source: 생태계에서 죽은 식물과 동물을 재활용하는 데 책임이 가장 큰 것은 세균입니다. 세균은 생분해 작용을 통해 유기물을 분해하여 영양분을 생성하고, 이를 다른 생물들이 이용할 수 있도록 합니다. 세균은 생태계의 중요한 구성원으로서, 죽은 식물과 동물의 분해와 분해 과정에서 발생하는 영양분의 순환을 도와줍니다. 이러한 세균의 역할은 생태계의 균형을 유지하는 데 매우 중요합니다. 세균은 또한 생태계에서 다양한 생물들의 생태적 상호작용에도 영향을 미치며, 생태계의 안정성과 다양성을 유지하는 데에도 기여합니다. 따라서 세균은 생태계에서 죽은 식물과 동물을 재활용하는 데 가장 큰 책임을 지고 있습니다.
score: 0.010716381 source: 세균은 무성 생식을 하는 유기체입니다. 이는 세균이 단일 부모로부터 새롭게 생산되는 것을 의미합니다. 세균은 유전자를 상속받는데, 이는 단일 부모와 같은 특성을 가지게 됩니다. 세균은 유전자의 조합을 통해 다양한 특성을 가질 수 있으며, 이는 세균의 다양성과 적응력을 높여줍니다. 세균은 빠른 성장과 번식 능력으로 인해 환경에서 매우 중요한 역할을 합니다. 세균은 다양한 환경에서 생존할 수 있으며, 이는 세균의 유전적 다양성과 적응력에 기인합니다. 세균은 우리 주변에 많이 존재하며, 우리의 건강에도 영향을 미칩니다. 세균의 특성을 이해하고 관리하는 것은 우리의 건강과 생활에 매우 중요합니다.
```

- 키워드가 그대로 포함되더라도 BM25 알고리즘에 따라 잘못된 문서에 점수가 높게 매겨지는 경우

```python
test_query = "건강한 입을 가지고 있는지 판단할 수 있는 방법에 대해 알려줘."  

# sparse retrieval
score: 15.83141 source: 입덧은 일반적으로 임신 초기 동안 문제가 됩니다. 임신 초기에는 여러 가지 이유로 입덧이 발생할 수 있습니다. 호르몬 변화로 인해 입안의 혈액 공급이 증가하고 침샘의 활동이 증가하기 때문에 입안이 민감해지고 침샘에서 분비되는 침의 양이 증가합니다. 이로 인해 입안이 산성으로 변하고 세균이 번식하기 쉬워지며, 이는 입덧의 주요 원인이 됩니다. 또한, 임신 초기에는 면역 체계가 약해지는 경향이 있어 입덧이 발생할 확률이 높아집니다. 따라서 임신 초기 동안 입덧에 대한 적절한 관리와 치료가 필요합니다. 입덧을 예방하기 위해서는 규칙적인 구강 위생 관리와 칫솔질, 치실 사용, 구강 청결을 유지하는 것이 중요합니다. 또한, 건강한 식습관과 충분한 수분 섭취도 입덧 예방에 도움이 됩니다. 만약 입덧이 발생한다면, 치과 의사와 상담하여 적절한 치료 방법을 받아야 합니다.
score: 12.876699 source: 정상적이고 건강한 입을 가진 환자에게서, 하악치를 지탱하는 치조골을 덮고 있는 점막은 점막 잇몸 접합부 아래는 빨강색이고 위는 연한 핑크색이라고 예상된다. 이 점막은 치아와 치조골 사이에 위치하여 치아를 보호하고 지지하는 역할을 한다. 또한, 이 점막은 치아 주위의 조직과 연결되어 있어 치아의 안정성을 유지하고 치아와 주변 조직 간의 상호작용을 조절한다. 이러한 점막은 치아의 건강을 유지하는 데 중요한 역할을 한다. 따라서, 정상적인 입을 가진 환자에게서 이러한 점막의 색상과 형태는 건강한 상태를 나타내는 지표로 사용될 수 있다.
score: 12.077877 source: 인간 노화를 연구하는 주요 이유 중 하나는 위의 모든 것 때문이다. 인간 노화는 인간의 생물학적, 심리적, 사회적 변화를 이해하고 예방하기 위해 연구되고 있다. 노화는 인간의 삶의 질을 저하시키고 질병의 발생률을 증가시키는 요인으로 알려져 있다. 따라서, 인간 노화를 연구함으로써 우리는 더 건강하고 행복한 노후를 보낼 수 있는 방법을 찾을 수 있을 것이다. 또한, 노화 연구는 인간의 수명을 연장시키는 방법을 발견하는 데에도 도움을 줄 수 있다. 인간의 수명은 과거 몇 십 년 동안 상당히 증가했지만, 아직도 노화에 대한 이해와 대처 방법에는 한계가 있다. 따라서, 인간 노화를 연구함으로써 우리는 더 긴 수명을 즐길 수 있는 방법을 발견할 수 있을 것이다. 인간 노화 연구는 또한 질병 예방과 치료에도 중요한 역할을 할 수 있다. 노화는 다양한 질병의 발생과 진행에 영향을 미치는 요인으로 알려져 있다. 따라서, 인간 노화를 연구함으로써 우리는 질병 예방과 치료에 대한 새로운 통찰력을 얻을 수 있을 것이다. 인간 노화 연구는 또한 사회적인 측면에서도 중요하다. 인구 고령화가 진행되면서, 노화에 대한 이해와 대처 방법은 사회 전반에 영향을 미치고 있다. 따라서, 인간 노화를 연구함으로써 우리는 사회적으로 더 건강하고 지속 가능한 노년을 만들 수 있을 것이다. 이러한 이유들로 인하여, 인간 노화를 연구하는 것은 매우 중요하다.
# dense retreival 
score: 0.010015365 source: 정상적이고 건강한 입을 가진 환자에게서, 하악치를 지탱하는 치조골을 덮고 있는 점막은 점막 잇몸 접합부 아래는 빨강색이고 위는 연한 핑크색이라고 예상된다. 이 점막은 치아와 치조골 사이에 위치하여 치아를 보호하고 지지하는 역할을 한다. 또한, 이 점막은 치아 주위의 조직과 연결되어 있어 치아의 안정성을 유지하고 치아와 주변 조직 간의 상호작용을 조절한다. 이러한 점막은 치아의 건강을 유지하는 데 중요한 역할을 한다. 따라서, 정상적인 입을 가진 환자에게서 이러한 점막의 색상과 형태는 건강한 상태를 나타내는 지표로 사용될 수 있다.
score: 0.009150982 source: 환자 중 한 명의 오른쪽 하악 측면의 절치의 순측 치조점막에서 병변을 발견했습니다. 이에 따라 구강 병리 보고서를 작성하기 위해 생체검사를 하기로 결정했습니다. 생체검사를 위해 통증 없이 신경을 차단하기 위해 어떤 신경에 국소적 마취를 해야 하는지 알아보겠습니다. 생체검사를 위해 국소적 마취를 사용하는 것은 일반적인 절차입니다. 이를 통해 환자는 통증 없이 생체검사를 받을 수 있습니다. 이 경우, 정신 신경을 국소적으로 마취하는 것이 가장 적합합니다...
score: 0.008786558 source: 환자의 아래턱 림프절이 부풀어 있는 것을 발견했습니다. 이는 잠재적인 감염의 증거일 수 있습니다. 감염된 부위를 찾기 위해서는 다음의 곳을 살펴볼 수 있습니다. 첫째로, 경구개를 확인해야 합니다. 경구개는 입안의 윗부분으로, 이곳에서 감염이 발생할 수 있습니다. 둘째로, 윗입술을 살펴보아야 합니다. 윗입술은 입술의 윗부분으로, 여기서도 감염이 발생할 수 있습니다. 셋째로, 상악중절치를 확인해야 합니다. 상악중절치는 상악에 위치한 치아들로, 이곳에서도 감염이 발생할 수 있습니다. 마지막으로, 제일대구치를 살펴보아야 합니다. 제일대구치는 아래턱에 위치한 치아로, 이곳에서도 감염이 발생할 수 있습니다. 따라서, 이러한 부위들을 주의깊게 살펴보면 잠재적인 감염 부위를 찾을 수 있을 것입니다.
```

### Hybrid Retrieval (Sparse Retrieval + Dense Retrieval)

- Elasticsearch의 쿼리 DSL을 사용하여 hybrid retrieval 구현
    
    ```python
    # 역색인 + Vector 유사도 혼합
    body = {
        "query": {
            "match": {
                "content": {
                    "query": query_str,
                    "boost": 0.0005 # 가중치
                }
            }
        },
        "knn": {
            "field": "embeddings",
            "query_vector": query_embedding.tolist(),
            "k": 5,
            "num_candidates": 50,
            "boost": 1
        },
        "size": size
    }
    
    es.search(index="test", body=body)
    ```
    
    - 결과 스코어는 KNN 스코어와 쿼리 스코어의 합계
    - boost 값을 지정하여 각 스코어에 가중치를 부여할 수 있음
        
        > score = 0.0025 * match_score + 1 * knn_score
        > 
        
        ⇒ 평가 데이터를 sampling한 검증 데이터셋에 대한 MAP 스코어를 기준으로 boost 값 튜닝
        

<aside>
👉 Hybrid Retrieval 사용 시 Public LB 스코어 - 0.7485 ⇒ 0.7939 : 약 0.05 상승

</aside>

## 3.6. sparse vector 기반 검색 성능 향상

<aside>
💡 hybrid retrieval로도 맞추지 못하는 데이터에 대해서는 sparse vector 기반 검색 성능을 높여 해결하는 방법을 시도했다.

</aside>

### sparse vector 유사도 모델 변경

- default BM25 → LMJelinekMercer

<aside>
ℹ️  BM25와 LMJelinekMercer 비교

1. BM25 (Best Matching 25):
    - 확률적 정보 검색 모델
    - 쿼리와 문서 간의 유사성을 측정할 때 단어의 출현 빈도(frequency)와 문서의 길이(length)를 고려
    - 검색 쿼리와 문서 간의 일치하는 단어의 수를 기반으로 점수를 계산
    - 단어가 문서에 자주 나타나거나 문서의 길이가 긴 경우에는 가중치를 줄이고, 쿼리와 문서 간의 일치하는 단어가 적거나 문서의 길이가 짧은 경우에는 가중치를 높이는 방식으로 동작
2. LM Jelinek-Mercer:
    - 언어 모델 기반의 유사도 모델
    - 쿼리와 문서 간의 유사성을 측정할 때 문서의 언어 모델을 사용하여 단어의 확률을 고려
    - 일반적으로 문서 내에서 각 단어의 확률은 문서의 일치성을 반영하는 데 사용됨
    - Jelinek-Mercer 스무딩은 많은 문서에 존재하지 않는 단어들에 대해 보다 적절한 가중치를 할당
    - BM25와는 달리 단어의 출현 빈도나 문서의 길이보다는 언어 모델을 기반으로 유사성을 측정하는 특징이 있음

< LMJelinekMercer 모델이 유리한 경우 >

1. 특정 도메인에서 문서와 쿼리의 언어적 특성이 중요한 역할을 하는 경우, 더 유리할 수 있음
2. 문서 길이의 분보가 매우 불균형한 경우, 평활화를 통해 문서 길이의 영향을 줄일 수 있음
3. 단일 파라미터 설정으로 여러 도메인에서 안정적인 성능을 제공함
</aside>

> 아래 예시 쿼리에 대해 BM25 사용 시 정답 문서를 검색하지 못하는 데 반해, LM Jelinek-Mercer 사용 시 정답 문서를 검색한다.
> 

```python
test_query = "빗방울이 점점 커지게 되는 요인은?"

# sparse retrieval with BM25
score: 23.388632 source: 무지개는 자연 현상으로, 빗방울 속의 빛이 굴절과 반사를 통해 생기게 됩니다. 빗방울은 투명한 물질로 이루어져 있으며, 빛은 빗방울에 닿으면 굴절됩니다. 이 굴절된 빛은 빗방울 내부에서 반사되어 다시 외부로 나오게 됩니다. 이렇게 반사된 빛은 다시 한 번 굴절되며, 다양한 색상으로 분리됩니다. 이렇게 분리된 색상들이 빗방울에서 나오면서 무지개가 형성되는 것입니다. 무지개는 일정한 각도로 형성되며, 태양이 빗방울에 닿는 각도와 빗방울의 크기에 따라 다양한 형태와 색상을 보여줍니다. 따라서, 무지개는 빗방울 속의 빛이 굴절과 반사를 통해 생기는 자연의 아름다운 현상입니다.
score: 19.680605 source: 물이 구름에서 다시 지구로 떨어질 때, 강수라는 현상이 일어납니다. 강수는 물의 순환 과정 중 하나로, 구름 안에 있는 수증기가 높은 고도에서 낮은 고도로 이동하면서 물방울로 변합니다. 이 물방울들은 구름 안에서 충돌하고 서로 합쳐져서 점점 커지게 됩니다. 그리고 어느 정도 크기가 되면 중력에 의해 지구로 떨어지게 됩니다. 이렇게 물이 구름에서 지구로 떨어지는 과정을 강수라고 합니다. 강수는 비, 눈, 우박 등 다양한 형태로 나타날 수 있으며, 지구의 생태계와 물의 순환에 중요한 역할을 합니다.
score: 14.358231 source: 당신은 금성에 살고 있고, 당신의 망원경이 금성의 두꺼운 구름을 볼 수 있다고 가정한다면, 지구의 달을 관찰할 수 있습니다. 지구의 달은 월식과 만월을 거치며 다양한 단계를 보여줍니다. 여기서는 월식이 아닌 단계를 중심으로 설명하겠습니다...
# sparse retrieval with LM Jelinek-Mercer
score: 14.111265 source: 물이 구름에서 다시 지구로 떨어질 때, 강수라는 현상이 일어납니다. 강수는 물의 순환 과정 중 하나로, 구름 안에 있는 수증기가 높은 고도에서 낮은 고도로 이동하면서 물방울로 변합니다. 이 물방울들은 구름 안에서 충돌하고 서로 합쳐져서 점점 커지게 됩니다. 그리고 어느 정도 크기가 되면 중력에 의해 지구로 떨어지게 됩니다. 이렇게 물이 구름에서 지구로 떨어지는 과정을 강수라고 합니다. 강수는 비, 눈, 우박 등 다양한 형태로 나타날 수 있으며, 지구의 생태계와 물의 순환에 중요한 역할을 합니다.
score: 13.345925 source: 무지개는 자연 현상으로, 빗방울 속의 빛이 굴절과 반사를 통해 생기게 됩니다. 빗방울은 투명한 물질로 이루어져 있으며, 빛은 빗방울에 닿으면 굴절됩니다. 이 굴절된 빛은 빗방울 내부에서 반사되어 다시 외부로 나오게 됩니다. 이렇게 반사된 빛은 다시 한 번 굴절되며, 다양한 색상으로 분리됩니다. 이렇게 분리된 색상들이 빗방울에서 나오면서 무지개가 형성되는 것입니다. 무지개는 일정한 각도로 형성되며, 태양이 빗방울에 닿는 각도와 빗방울의 크기에 따라 다양한 형태와 색상을 보여줍니다. 따라서, 무지개는 빗방울 속의 빛이 굴절과 반사를 통해 생기는 자연의 아름다운 현상입니다.
score: 9.677388 source: 당신은 금성에 살고 있고, 당신의 망원경이 금성의 두꺼운 구름을 볼 수 있다고 가정한다면, 지구의 달을 관찰할 수 있습니다. 지구의 달은 월식과 만월을 거치며 다양한 단계를 보여줍니다. 여기서는 월식이 아닌 단계를 중심으로 설명하겠습니다...

------------

test_query = "물체를 매우 크게 확대해서 볼수 있는 기계" 
# sparse retrieval with BM25
score: 15.284601 source: 많은 일반 수공도구들은 간단한 기계에서 볼 수 있는 기본 원리를 사용하여 기계적 이점을 제공합니다. 예를 들어, 스크루드라이버는 바퀴와 축의 원리를 사용하여 회전력을 전달하고 나사를 조이는 역할을 합니다. 또한, 플라이어는 지렛대 원리를 사용하여 그립력을 높이고 물체를 잡을 수 있습니다. 지렛대는 한쪽 끝에 힘을 가하면 다른쪽 끝에는 더 큰 힘이 발생하는 원리를 이용합니다. 이를 통해 플라이어는 작은 힘으로도 큰 물체를 잡을 수 있습니다. 따라서, 수공도구들은 간단한 기계적 원리를 활용하여 우리의 일상 생활을 편리하게 만들어줍니다.
score: 14.6367235 source: 현미경은 물체를 50배로 확대할 수 있습니다. 따라서, 물체의 실제 길이는 상으로 보이는 길이의 1/50인 0.01cm입니다. 현미경을 사용하면 물체의 세부 사항을 더욱 자세히 관찰할 수 있습니다.
score: 12.890602 source: 토크는 레버 암과 곱한 힘이다. 이는 물체에 가해지는 회전력을 나타내는 물리적인 힘입니다. 토크는 레버 암의 길이와 힘의 크기에 따라 결정됩니다. 레버 암이 길면 토크는 강력해지고, 힘의 크기가 크면 토크도 커집니다. 토크는 회전하는 물체에 영향을 주는 중요한 힘으로, 자동차의 엔진, 기계의 회전 부품 등에서 사용됩니다. 토크는 회전 운동을 이해하고 설계하는데 필수적인 개념이며, 엔지니어링 분야에서 중요한 역할을 합니다.
# sparse retrieval with LM Jelinek-Mercer
score: 11.073102 source: 현미경은 물체를 50배로 확대할 수 있습니다. 따라서, 물체의 실제 길이는 상으로 보이는 길이의 1/50인 0.01cm입니다. 현미경을 사용하면 물체의 세부 사항을 더욱 자세히 관찰할 수 있습니다.
score: 9.110226 source: 많은 일반 수공도구들은 간단한 기계에서 볼 수 있는 기본 원리를 사용하여 기계적 이점을 제공합니다. 예를 들어, 스크루드라이버는 바퀴와 축의 원리를 사용하여 회전력을 전달하고 나사를 조이는 역할을 합니다. 또한, 플라이어는 지렛대 원리를 사용하여 그립력을 높이고 물체를 잡을 수 있습니다. 지렛대는 한쪽 끝에 힘을 가하면 다른쪽 끝에는 더 큰 힘이 발생하는 원리를 이용합니다. 이를 통해 플라이어는 작은 힘으로도 큰 물체를 잡을 수 있습니다. 따라서, 수공도구들은 간단한 기계적 원리를 활용하여 우리의 일상 생활을 편리하게 만들어줍니다.
score: 8.6020355 source: 객체의 선형 크기를 3배로 확대하면 표면적은 9배 증가하고 부피는 27배 증가합니다. 이는 선형 크기와 표면적, 부피 간의 비례 관계에 기반한 결과입니다. 선형 크기가 증가하면 표면적은 선형 크기의 제곱에 비례하여 증가하고, 부피는 선형 크기의 세제곱에 비례하여 증가합니다. 따라서, 객체의 선형 크기를 3배로 확대하면 표면적은 9배 증가하고 부피는 27배 증가합니다.
```

<aside>
👉 LM Jelinek-Mercer 사용 시 Public LB 스코어 - 0.7939 ⇒ 0.8167 : 약 0.02 상승

</aside>

### hybrid retrieval의 역색인 기반 검색 가중치 변경

- 역색인 기반 검색 성능이 향상되었으므로 하이브리드 검색 시 역색인 기반 검색 가중치를 0.0005에서 0.002로 변경

```python
"match": {
		"content": {
				"query": query_str,
		    "boost": 0.002
    }
}
```

<aside>
👉 match boost 값 변경 후 Public LB 스코어 - 0.8167 ⇒ 0.8515 : 약 0.04 상승

</aside>

### nori analyzer에 동의어 filter 추가

- sparse retrieval 시 동의어를 고려할 수 있도록 synonym filter 추가
    - 예를 들어, "다음 세대"와 "후손"이 동의어로 등록되어 있다면 "다음 세대"로 검색한 결과에 "후손"이 포함된 문서도 검색 결과로 반환됨

```python
"synonyms_filter": {
    "type": "synonym",
    "lenient": True,
    "synonyms": [
        "복숭아, 복숭아나무",
        "밀물, 만조",
        "썰물, 간조",
        "관계, 상호작용",
        "순기능, 도움",
        "리보오솜, 리보솜",
        "네트웍, 네트워크",
        "역할, 기능, 기여, 담당",
        "전력, 전류",
        "땅, 토양",
        "가장 많이, 대부분",
        "단점, 부정적인",
        "형태, 유형",
        "자연, 생태계",
        "뭉쳐, 모여",
        "날씨, 기후",
        "측정, 추정",
        "관계, 영향",
        "뭐야, 의미",
        "해안, 바다",
        "전구, 램프",
        "번식, 생식",
        "다음 세대, 후손",
        "무게, 질량",
        "잠, 수면",
        "약, 약물",
        "자석, 자성체",
        "결혼 전, 혼전",
        "숨, 호흡"
    ]
}

# analyzer
"nori": {
    "type": "custom",
    "tokenizer": "nori_tokenizer",
    "decompound_mode": "mixed", 
    "filter": ["nori_posfilter", "synonyms_filter"]
 }
```

<aside>
👉 유사도 필터 추가 후 Public LB 스코어 - 0.8515 ⇒ 0.9045 : 약 0.05 상승

</aside>

# 4. 경진대회 결과

## 4.1. 리더보드 순위

- Public 리더보드
    - 2위, MAP score: 0.9045

![스크린샷 2024-05-06 오전 12.28.56.png](https://github.com/8pril/upstage-ai-final-ir/assets/40953615/b0757749-515a-40cd-99bf-9ba06654518d)

- Private(최종) 리더보드
    - 2위, MAP score: 0.8652

![스크린샷 2024-05-06 오전 12.29.07.png](https://github.com/8pril/upstage-ai-final-ir/assets/40953615/99ac4524-4c05-4d44-abf9-0e4a3c52a787)

## 4.2. 결과 분석

### 스코어 향상에 도움이 된 핵심 시도 및 전략

1. 프롬프트 엔지니어링
    - Baseline 프롬프트의 질의 분석 정확도는 220개 중 116개로 약 0.98이었으나 프롬프트 엔지니어링을 통해 220개 데이터 모두 지식 관련 대화 혹은 일반 대화로 정확히 분류되도록 하였다. 또한 지식 관련 대화에 대해 검색을 위한 쿼리 추출 시 키워드가 누락되는 문제를 해결하도록 프롬프트를 수정하여 검색엔진의 성능을 향상시킬 수 있었다. 결론적으로 프롬프트 엔지니어링만으로 약 5%의 스코어 향상을 이루었다.
2. dense retrieval 고도화 (고성능 임베딩 모델 선택)
    - 검증 데이터에 대해 여러 임베딩 모델로 임베딩 vector를 생성하고 dense retrieval을 수행한 뒤 스코어를 비교하여 가장 높은 성능을 보인 임베딩 모델을 선택했다.
3. sparse vector 기반 검색 + dense vector 기반 검색 혼합
    - 데이터 분석을 통해 역색인 기반 검색에 유리한 데이터와 임베딩 유사도 기반 검색에 유리한 데이터가 고루 존재함을 확인했다. 이 사실로부터 역색인 기반 검색과 임베딩 기반 검색 결과를 적절히 앙상블하는 방법이 스코어 향상에 도움이 될 것으로 판단했다. Elasticsearch는 hybrid retrieval을 위한 쿼리 DSL을 지원한다. 이는 두 가지 방식의 검색을 각각 수행한 뒤 유사도 스코어를 soft voting하는 방식과 유사하다. 여러 임베딩 모델로 얻은 임베딩 벡터로 검색 성능을 비교한 뒤 가장 높은 성능을 보인 sRoBERTa 모델을 역색인과 혼합하여 약 5%의 스코어 향상을 이루었다.
4. 동의어 필터 추가
    - dense retrieval 고도화 및 hybrid retrieval 구현을 통해 sparse vector만을 사용한 검색 성능의 한계를 어느정도 개선할 수 있었다. 그 지점에서 성능을 더 끌어올리기 위한 방법으로 여러 선택지가 있었는데, 역색인 모델 고도화를 통해 sparse vector 기반의 검색 성능 역시 향상시키는 방법을 시도했다. 역색인 기반 검색의 가장 큰 약점은 의미 차원의 유사도 비교인데, 동의어 필터를 사용해 검색 시 유사한 의미의 키워드를 고려할 수 있도록 하여 기존에 올바르게 검색하지 못하던 쿼리에 대해 정답 문서의 유사도 스코어를 높일 수 있고, 그 결과 hybrid retrieval의 종합적인 정확도를 향상시킬 수 있었다.

### 경진대회 진행 소감

- 이번 대회는 기존의 ML 경진대회와는 다르게 모델 학습보다는 임베딩 생성 모델, 검색엔진, LLM 등을 활용하여 RAG 시스템의 성능을 향상시키는 것이 목적이었다. 대회 취지에 맞게 프롬프트 엔지니어링, LLM을 활용한 데이터 생성, Elasticsearch을 통한 검색 성능 고도화 등의 다양한 접근법을 시도해볼 수 있어서 대회 진행 과정이 유독 재미있었다.
- 계획했던 접근법 중 마지막 순서로 두었던 reranking을 시도해보지 못한 것이 아쉽다. reranking은 스코어 향상을 높은 확률로 기대할 수 있는 방법이기는 했으나, 앞선 주요 접근법을 모두 시도해본 다음 마지막으로 스코어를 끌어올리기 위한 후처리 방식이었기 때문에 우선순위가 낮았고, 대회 마지막날까지 성능 향상을 이루었기 때문에 사실상 reranking을 시도할 타이밍을 잡지 못했다. 또한 시간상의 한계로 임베딩 모델 파인튜닝을 다각도로 시도해보지 못한 것에 아쉬움이 남는다.
- 하지만 1위, 3위의 방법론 중 핵심이 reranking 모델이었던 것을 고려하면 reranking 없이 0.90대의 높은 스코어를 기록한 것이 시도의 다양성 및 검색엔진 자체의 성능 측면에서는 오히려 의미 있는 결과라고 생각한다.
